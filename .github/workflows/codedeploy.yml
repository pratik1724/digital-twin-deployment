name: CI → CodeDeploy (Test → Prod with Approval)
environment: test
steps:
- name: Configure AWS credentials
uses: aws-actions/configure-aws-credentials@v3
with:
aws-access-key-id: ${{ secrets.AWS_DEPLOY_KEY_ID }}
aws-secret-access-key: ${{ secrets.AWS_DEPLOY_SECRET }}
aws-region: ${{ env.AWS_REGION }}


- name: Create CodeDeploy deployment (TEST)
id: create_deploy_test
run: |
S3_KEY="${{ needs.build.outputs.s3_key }}"
echo "Using S3 Key: $S3_KEY"
DEPLOY_ID=$(aws deploy create-deployment \
--application-name "${{ env.APP_NAME }}" \
--deployment-group-name "${{ env.TEST_DGROUP }}" \
--revision "revisionType=S3,s3Location={bucket=${{ env.S3_BUCKET }},key=${S3_KEY},bundleType=zip}" \
--description "Deploy to TEST from GH ${GITHUB_SHA}" \
--query "deploymentId" --output text)
echo "deployment_id=$DEPLOY_ID" >> $GITHUB_OUTPUT


- name: Wait for CodeDeploy finish (TEST)
run: |
DEPLOY_ID="${{ steps.create_deploy_test.outputs.deployment_id }}"
echo "Waiting for deployment $DEPLOY_ID to complete..."
aws deploy wait deployment-successful --deployment-id "$DEPLOY_ID"
echo "Test deployment completed."


approve-production:
name: Manual approval for PRODUCTION
needs: deploy-test
runs-on: ubuntu-latest
environment:
name: production
url: https://your-production-url.example.com
steps:
- name: Await approval
run: |
echo "This job waits for a production environment approval in GitHub (go to Actions → required approvers)."


deploy-prod:
name: Deploy → PROD (CodeDeploy)
needs: approve-production
runs-on: ubuntu-latest
steps:
- name: Configure AWS credentials
uses: aws-actions/configure-aws-credentials@v3
with:
aws-access-key-id: ${{ secrets.AWS_DEPLOY_KEY_ID }}
aws-secret-access-key: ${{ secrets.AWS_DEPLOY_SECRET }}
aws-region: ${{ env.AWS_REGION }}


- name: Create CodeDeploy deployment (PROD)
id: create_deploy_prod
run: |
S3_KEY="${{ needs.build.outputs.s3_key }}"
DEPLOY_ID=$(aws deploy create-deployment \
--application-name "${{ env.APP_NAME }}" \
--deployment-group-name "${{ env.PROD_DGROUP }}" \
--revision "revisionType=S3,s3Location={bucket=${{ env.S3_BUCKET }},key=${S3_KEY},bundleType=zip}" \
--description "Deploy to PROD from GH ${GITHUB_SHA}" \
--query "deploymentId" --output text)
echo "deployment_id=$DEPLOY_ID" >> $GITHUB_OUTPUT


- name: Wait for CodeDeploy finish (PROD)
run: |
DEPLOY_ID="${{ steps.create_deploy_prod.outputs.deployment_id }}"
echo "Waiting for deployment $DEPLOY_ID to complete..."
aws deploy wait deployment-successful --deployment-id "$DEPLOY_ID"
echo "Production deployment completed."
